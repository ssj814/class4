<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="NoticeMapper">

    <!-- 전체 글 목록 조회, 제목/작성자/내용 검색 -->
    <select id="selectBoardList" resultType="BoardPostsDTO" parameterType="hashmap">
        SELECT *
        FROM (
            SELECT rownum AS rnum, t.*
            FROM (
                SELECT post_id AS postId, 
                       title, 
                       content, 
                       writer, 
                       TO_CHAR(created_at, 'yy/mm/dd') AS createdAt, 
                       viewcount AS viewCount, 
                       category_id AS categoryId
                FROM BOARD_POSTS
                WHERE category_id = #{categoryId}
                <if test="searchKey != null and searchValue != null">
                    AND LOWER(${searchKey}) LIKE '%' || LOWER(#{searchValue}) || '%'
                </if>
                ORDER BY post_id DESC
            ) t
        ) 
        WHERE rnum BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 글 세부내용 조회 -->
    <select id="selectBoardOne" resultType="BoardPostsDTO" parameterType="int">
        SELECT post_id AS postId, 
               title, 
               content, 
               writer, 
               TO_CHAR(created_at, 'yy/mm/dd') AS createdAt, 
               viewcount AS viewCount, 
               popup
        FROM BOARD_POSTS
        WHERE post_id = #{postId}
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount" parameterType="int">
        UPDATE BOARD_POSTS
        SET viewcount = viewcount + 1
        WHERE post_id = #{postId}
    </update>

    <!-- 글 저장 -->
    <insert id="insertContent" parameterType="BoardPostsDTO">
        INSERT INTO BOARD_POSTS (post_id, title, content, writer, created_at, category_id, popup)
        VALUES (#{postId}, #{title}, #{content}, #{writer}, SYSDATE, #{categoryId}, #{popup})
    </insert>

    <!-- 글 삭제 -->
    <delete id="boardDelete" parameterType="int">
        DELETE FROM BOARD_POSTS
        WHERE post_id = #{postId}
    </delete>

    <!-- 글 수정 -->
    <update id="updateContent" parameterType="BoardPostsDTO">
        UPDATE BOARD_POSTS
        SET title = #{title}, 
            content = #{content}, 
            category_id = #{categoryId}, 
            popup = #{popup}
        WHERE post_id = #{postId}
    </update>

    <!-- 전체 공지사항 글 갯수 -->
    <select id="getTotalCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM BOARD_POSTS
        WHERE category_id = #{categoryId}
        <if test="searchKey != null and searchValue != null">
            AND LOWER(${searchKey}) LIKE '%' || LOWER(#{searchValue}) || '%'
        </if>
    </select>

    <!-- 팝업 공지 가져오기 -->
    <select id="selectPopupPosts" resultType="BoardPostsDTO">
        SELECT post_id AS postId, 
               title, 
               content, 
               writer, 
               popup, 
               created_at AS createdAt
        FROM BOARD_POSTS
        WHERE popup = 'Y' AND category_id = 1
        ORDER BY created_at ASC
    </select>

    <!-- 팝업 비활성화 -->
    <update id="updatePopupToN" parameterType="BoardPostsDTO">
        UPDATE BOARD_POSTS
        SET popup = 'N'
        WHERE post_id = #{postId}
    </update>
</mapper>
